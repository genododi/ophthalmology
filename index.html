<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ophthalmic Infographic Creator</title>
    <!-- Favicon to prevent 404 - multiple formats for browser compatibility -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üëÅÔ∏è</text></svg>">
    <link rel="icon" type="image/x-icon"
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD/4p0A/+KdAP/inQD/4p0A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A////AP///wD///8A////AP///wD///8A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A////AP///wD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA//+KdAP/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD///8A////AP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP///wD///8A////AP///wD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP///wD///8A////AP///wD///8A////AP///wD///8A////AP/inQD/4p0A/+KdAP/inQD////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP/DAAD/gQAA/wAAAOAAAADAAAAAQAAAAAAAAAAAAAAAAAAAAIAAAACAAAABwAAA/4AAAP/BAAD//wAA">
    <link rel="shortcut icon"
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD/4p0A/+KdAP/inQD/4p0A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A////AP///wD///8A////AP///wD///8A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A////AP///wD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA//+KdAP/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP8AAAD/AAAA/wAAAP8AAAD//+KdAP/inQD/4p0A/+KdAP/inQD///8A////AP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP///wD///8A////AP///wD/4p0A/+KdAP/inQD/4p0A/+KdAP/inQD/4p0A/+KdAP///wD///8A////AP///wD///8A////AP///wD///8A////AP/inQD/4p0A/+KdAP/inQD////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP/DAAD/gQAA/wAAAOAAAADAAAAAQAAAAAAAAAAAAAAAAAAAAIAAAACAAAABwAAA/4AAAP/BAAD//wAA">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">
    <!-- Import map for ES modules - works on hosted servers -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <!-- PDF.js for client-side PDF text extraction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <!-- Firebase SDK for alternative storage (no size limits) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar Toggle Button -->
        <button id="sidebar-toggle" class="sidebar-toggle" title="Toggle Sidebar">
            <span class="material-symbols-rounded">chevron_left</span>
        </button>

        <!-- Sidebar / Control Panel -->
        <aside class="sidebar" id="sidebar">
            <div class="brand">
                <span class="material-symbols-rounded icon">visibility</span>
                <h1>Ophthalmic<br>Infograph</h1>
            </div>

            <div class="control-group">
                <label for="api-key">Gemini API Key</label>
                <div class="input-wrapper">
                    <span class="material-symbols-rounded input-icon">key</span>
                    <input type="password" id="api-key" placeholder="Enter your key here">
                </div>
                <small class="hint">Your key is not stored permanently.</small>
            </div>

            <div class="control-group">
                <label for="topic-input">Topic or Text</label>
                <textarea id="topic-input"
                    placeholder="Paste your text or describe an ophthalmic topic (e.g., 'Glaucoma management guidelines')..."></textarea>
            </div>

            <!-- Resource Upload Section -->
            <div class="control-group resource-upload-group">
                <label>Attach Resources (Optional)</label>
                <div class="file-upload-wrapper">
                    <input type="file" id="resource-upload" accept=".pdf,.txt" multiple hidden>
                    <button type="button" class="file-upload-btn" id="upload-trigger-btn">
                        <span class="material-symbols-rounded">upload_file</span>
                        Upload PDF or TXT
                    </button>
                </div>
                <div id="uploaded-files-list" class="uploaded-files"></div>
                <small class="hint">Upload PDF or TXT files to use as source material for generation</small>
            </div>

            <button id="generate-btn" class="primary-btn">
                Generate Infographic
            </button>

            <!-- Quick Access Library Button -->
            <button id="sidebar-library-btn" class="secondary-btn"
                style="margin-top: 0.75rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; background: linear-gradient(135deg, #334155 0%, #1e293b 100%); color: #e2e8f0; border: 1px solid #475569; border-radius: 12px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease;">
                <span class="material-symbols-rounded" style="font-size: 1.2rem;">inventory_2</span>
                Open Library
            </button>

            <!-- Studio Tools Panel - NotebookLM Style -->
            <div class="studio-tools-panel" id="studio-panel">
                <div class="studio-header">
                    <span class="material-symbols-rounded">auto_awesome</span>
                    <h3>Studio Tools</h3>
                </div>
                <div class="studio-tools-grid">
                    <button class="studio-tool-btn" id="audio-overview-btn" title="Generate Audio Overview">
                        <span class="material-symbols-rounded">headphones</span>
                        <span class="tool-label">Audio Overview</span>
                    </button>
                    <button class="studio-tool-btn" id="video-overview-btn" title="Generate Video Overview">
                        <span class="material-symbols-rounded">smart_display</span>
                        <span class="tool-label">Video Overview</span>
                    </button>
                    <button class="studio-tool-btn" id="mindmap-view-btn" title="Interactive Mind Map">
                        <span class="material-symbols-rounded">hub</span>
                        <span class="tool-label">Mind Map</span>
                    </button>
                    <button class="studio-tool-btn" id="report-btn" title="Generate Text Report">
                        <span class="material-symbols-rounded">description</span>
                        <span class="tool-label">Reports</span>
                    </button>
                    <button class="studio-tool-btn" id="flashcards-btn" title="Create Flashcards">
                        <span class="material-symbols-rounded">style</span>
                        <span class="tool-label">Flashcards</span>
                    </button>
                    <button class="studio-tool-btn" id="quiz-btn" title="Interactive Quiz">
                        <span class="material-symbols-rounded">quiz</span>
                        <span class="tool-label">Quiz</span>
                    </button>
                    <button class="studio-tool-btn" id="slidedeck-btn" title="Generate Slide Deck">
                        <span class="material-symbols-rounded">slideshow</span>
                        <span class="tool-label">Slide Deck</span>
                    </button>
                    <button class="studio-tool-btn" id="kanski-pics-btn" title="Import Clinical Photos">
                        <span class="material-symbols-rounded">imagesmode</span>
                        <span class="tool-label">Pics</span>
                    </button>
                    <input type="file" id="kanski-pdf-input" accept=".pdf,application/pdf" style="display: none;">
                    <button class="studio-tool-btn" id="sticky-notes-btn" title="View Sticky Notes">
                        <span class="material-symbols-rounded">sticky_note_2</span>
                        <span class="tool-label">Sticky Notes</span>
                    </button>
                </div>
                <p class="studio-hint">Generate an infographic first to unlock these tools</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="top-controls">
                <div class="action-group" id="context-actions">
                    <button class="icon-btn" id="print-btn" title="Print Poster (A4)">
                        <span class="material-symbols-rounded">print</span>
                    </button>
                    <button class="icon-btn" id="poster-btn" title="Toggle Landscape Poster">
                        <span class="material-symbols-rounded">panorama</span>
                    </button>
                    <button class="icon-btn" id="read-aloud-btn" title="Read Infographic">
                        <span class="material-symbols-rounded">record_voice_over</span>
                    </button>
                    <button class="icon-btn" id="save-btn" title="Save to Knowledge Base">
                        <span class="material-symbols-rounded">bookmark_add</span>
                    </button>
                    <button class="icon-btn" id="submit-community-btn" title="Submit to Community">
                        <span class="material-symbols-rounded">group_add</span>
                    </button>
                    <button class="icon-btn" id="download-pdf-btn" title="Download PDF" style="display: none;">
                        <span class="material-symbols-rounded">download</span>
                    </button>
                </div>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
                <div class="action-group" id="global-actions">
                    <button class="icon-btn" id="home-btn" title="Home / Reset">
                        <span class="material-symbols-rounded">home</span>
                    </button>
                    <button class="icon-btn" id="sync-btn" title="Sync with Server">
                        <span class="material-symbols-rounded">sync</span>
                    </button>
                    <button class="icon-btn" id="sync-status-btn" title="Library Sync Status">
                        <span class="material-symbols-rounded">compare_arrows</span>
                    </button>
                    <button class="icon-btn" id="ftp-btn" title="FTP Server Settings">
                        <span class="material-symbols-rounded">cloud_sync</span>
                    </button>
                    <button class="icon-btn" id="community-btn" title="Community Hub">
                        <span class="material-symbols-rounded">groups</span>
                    </button>
                    <a href="moderation.html" class="icon-btn" id="admin-btn" title="Admin Moderation Panel">
                        <span class="material-symbols-rounded">admin_panel_settings</span>
                    </a>
                    <a href="qa-generator.html" class="icon-btn" id="qa-btn" title="Q&A Generator (Viva & OSCE)">
                        <span class="material-symbols-rounded">quiz</span>
                    </a>
                    <button class="icon-btn" id="library-btn" title="Open Knowledge Base">
                        <span class="material-symbols-rounded">inventory_2</span>
                    </button>
                    <button class="icon-btn" id="notebooklm-toggle-btn" title="Toggle NotebookLM Portal"
                        style="color: #6366f1;">
                        <span class="material-symbols-rounded">dock_to_right</span>
                    </button>
                </div>
            </div>

            <div id="output-container" class="output-wrapper empty-state">
                <div class="empty-icon-container">
                    <span class="material-symbols-rounded">auto_awesome</span>
                </div>
                <div class="empty-message">
                    <h2>Design Your Infographic</h2>
                    <p>Enter an ophthalmic topic (e.g., "Diabetic Retinopathy Stages") or paste text to generate a
                        professional visual summary.</p>
                    <button id="library-btn-empty" class="btn-text-icon" style="margin-top: 1.5rem;">
                        <span class="material-symbols-rounded">inventory_2</span>
                        Open Library
                    </button>
                </div>
                <!-- Infographic content will be injected here -->
            </div>

            <!-- Hidden container for Text Report Printing -->
            <div id="text-report-container" class="text-report-wrapper" style="display: none;"></div>
        </main>

        <!-- NotebookLM Notes Mirror Panel -->
        <aside class="notebooklm-panel" id="notebooklm-panel">
            <!-- Panel Header -->
            <div class="nlm-panel-header">
                <div class="nlm-title-row">
                    <h2 class="nlm-title">
                        <span class="material-symbols-rounded">book</span>
                        NotebookLM Notes
                        <span class="nlm-count-badge" id="nlm-count-badge" style="display:none;">0</span>
                    </h2>
                    <div class="nlm-header-actions">
                        <a href="https://notebooklm.google.com/notebook/07d17136-d624-417d-8b82-6977f9674f71?pli=1&authuser=0&pageId=none"
                            target="_blank" class="nlm-action-btn" title="Open NotebookLM">
                            <span class="material-symbols-rounded">open_in_new</span>
                        </a>
                        <button class="nlm-action-btn" id="nlm-sync-gist-btn" title="Sync Notes from Pool">
                            <span class="material-symbols-rounded">cloud_download</span>
                        </button>
                        <button class="nlm-action-btn" id="nlm-sync-sticky-btn" title="Sync with Sticky Notes"
                            style="background: rgba(251, 191, 36, 0.3);">
                            <span class="material-symbols-rounded">sync</span>
                        </button>
                        <button class="nlm-action-btn" id="close-notebooklm-btn" title="Close Panel">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                    </div>
                </div>
                <!-- Search -->
                <div class="nlm-search-row">
                    <span class="material-symbols-rounded nlm-search-icon">search</span>
                    <input type="text" id="nlm-search-input" class="nlm-search-input" placeholder="Search notes...">
                </div>
            </div>

            <!-- Bulk Import Area (collapsible) -->
            <div class="nlm-import-area" id="nlm-import-area">
                <button class="nlm-import-toggle" id="nlm-import-toggle">
                    <span class="material-symbols-rounded">add_notes</span>
                    Import Notes
                    <span class="material-symbols-rounded nlm-toggle-chevron">expand_more</span>
                </button>
                <div class="nlm-import-body" id="nlm-import-body" style="display:none;">
                    <textarea id="nlm-paste-area" class="nlm-paste-area"
                        placeholder="Paste notes from NotebookLM here...&#10;&#10;Separate multiple notes with '---' or leave a blank line between them."></textarea>
                    <div class="nlm-import-actions">
                        <button class="nlm-btn-import" id="nlm-add-pasted-btn">
                            <span class="material-symbols-rounded">add</span>
                            Add Notes
                        </button>
                        <button class="nlm-btn-clear-all" id="nlm-clear-all-btn">
                            <span class="material-symbols-rounded">delete_sweep</span>
                            Clear All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Notes List -->
            <div class="nlm-notes-list" id="nlm-notes-list">
                <div class="nlm-empty-state" id="nlm-empty-state">
                    <span class="material-symbols-rounded">note_stack</span>
                    <p>No notes imported yet</p>
                    <small>Paste notes from NotebookLM or sync from the pool</small>
                </div>
            </div>
        </aside>
    </div>

    <!-- Library Modal -->
    <div id="library-modal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>Knowledge Base <span id="library-count-badge" class="count-badge" style="display: none;">0</span>
                </h2>
                <div style="display: flex; gap: 8px;">
                    <button id="auto-chapter-btn" class="icon-btn-ghost" title="Auto-Chapterize by Title">
                        <span class="material-symbols-rounded">auto_awesome</span>
                    </button>
                    <button id="find-duplicates-btn" class="icon-btn-ghost" title="Find & Remove Duplicates">
                        <span class="material-symbols-rounded">content_copy</span>
                    </button>
                    <button id="import-server-btn" class="icon-btn-ghost" title="Import from Server">
                        <span class="material-symbols-rounded">cloud_download</span>
                    </button>
                    <button id="export-server-btn" class="icon-btn-ghost" title="Upload to Server / Submit to Community"
                        style="display: none;">
                        <span class="material-symbols-rounded">cloud_upload</span>
                    </button>
                    <button id="check-categorisation-btn" class="icon-btn-ghost" title="Check / Correct Categorisation">
                        <span class="material-symbols-rounded">fact_check</span>
                    </button>
                    <button id="red-flags-btn" class="icon-btn-ghost" title="View Red Flags Section"
                        style="color: #ef4444;">
                        <span class="material-symbols-rounded">flag</span>
                    </button>
                    <button id="close-modal-btn" class="icon-btn-ghost">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div id="saved-items-list" class="saved-list">
                    <!-- Items will be injected here -->
                </div>
                <div id="empty-library-msg" class="empty-state-small">
                    <span class="material-symbols-rounded">folder_off</span>
                    <p>No saved infographics yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status Modal -->
    <div id="sync-status-modal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">compare_arrows</span>
                    üìä Library Sync Status
                </h2>
                <button id="close-sync-status-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body sync-status-modal-body">
                <div class="sync-status-preference">
                    <span class="material-symbols-rounded">tune</span>
                    <span>Sync Preference:</span>
                    <div class="preference-toggle" id="sync-preference-toggle">
                        <button class="pref-btn active" data-pref="local"
                            title="Keep local versions when conflicts occur">
                            <span class="material-symbols-rounded">folder</span> Local First
                        </button>
                        <button class="pref-btn" data-pref="server" title="Prefer server versions when conflicts occur">
                            <span class="material-symbols-rounded">cloud</span> Server First
                        </button>
                    </div>
                </div>
                <div id="sync-status-content" class="sync-status-content">
                    <div class="sync-loading">
                        <span class="material-symbols-rounded rotating">sync</span>
                        <p>Comparing libraries...</p>
                    </div>
                </div>
                <div class="sync-status-actions"
                    style="margin-top: 1rem; display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                    <button id="download-server-only-btn" class="btn-secondary" style="display: none;">
                        <span class="material-symbols-rounded">cloud_download</span>
                        Download Server-Only Infographs
                    </button>
                    <button id="export-local-only-btn" class="btn-primary" style="display: none;">
                        <span class="material-symbols-rounded">cloud_upload</span>
                        Publish Local-Only to Community Hub
                    </button>
                    <button id="refresh-sync-status-btn" class="btn-secondary">
                        <span class="material-symbols-rounded">refresh</span>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FTP Server Modal -->
    <div id="ftp-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">cloud_sync</span>
                    FTP Server Settings
                </h2>
                <button id="close-ftp-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body ftp-modal-body">
                <div id="ftp-status" class="ftp-status-container">
                    <div class="ftp-status-badge stopped">
                        <span class="material-symbols-rounded">cloud_off</span>
                        Not Running
                    </div>
                    <p class="ftp-info">Start the FTP server to allow remote users to access the knowledge base.</p>
                </div>
                <div class="ftp-controls">
                    <button id="start-ftp-btn" class="btn-primary">
                        <span class="material-symbols-rounded">play_arrow</span>
                        Start FTP Server
                    </button>
                    <button id="stop-ftp-btn" class="btn-secondary">
                        <span class="material-symbols-rounded">stop</span>
                        Stop Server
                    </button>
                </div>
                <div class="ftp-instructions">
                    <h4>How to Connect</h4>
                    <ol>
                        <li>Start the Node.js backend server: <code>node server.js</code></li>
                        <li>Click "Start FTP Server" above</li>
                        <li>Use any FTP client (FileZilla, Cyberduck, etc.)</li>
                        <li>Connect to the provided address with credentials</li>
                        <li>Access and download saved infographics remotely</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Overview Modal -->
    <div id="audio-modal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">headphones</span>
                    Audio Overview
                </h2>
                <button id="close-audio-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body audio-modal-body">
                <div class="audio-player-container">
                    <div class="audio-visualization" id="audio-viz">
                        <div class="audio-waveform"></div>
                    </div>
                    <div class="audio-controls">
                        <button class="audio-control-btn" id="audio-play-btn">
                            <span class="material-symbols-rounded">play_arrow</span>
                        </button>
                        <div class="audio-progress">
                            <div class="audio-progress-bar" id="audio-progress-bar"></div>
                        </div>
                        <span class="audio-time" id="audio-time">0:00</span>
                    </div>
                    <div class="audio-options">
                        <label>Voice Style:</label>
                        <select id="voice-select">
                            <option value="default">Professional</option>
                            <option value="friendly">Friendly</option>
                            <option value="formal">Formal</option>
                            <option value="p2p_female">P2P Female Conversation</option>
                        </select>
                        <button class="btn-secondary" id="generate-audio-btn">
                            <span class="material-symbols-rounded">record_voice_over</span>
                            Generate Audio
                        </button>
                        <button class="btn-secondary" id="download-audio-btn" style="display: none;">
                            <span class="material-symbols-rounded">download</span>
                            Download
                        </button>
                    </div>
                </div>
                <div class="audio-transcript">
                    <h4>Transcript Preview</h4>
                    <div id="audio-transcript-text" class="transcript-text"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Overview Modal -->
    <div id="video-modal" class="modal-overlay">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">smart_display</span>
                    Video Overview
                </h2>
                <button id="close-video-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body video-modal-body">
                <div class="video-player-container">
                    <div class="video-preview" id="video-preview">
                        <div class="video-slide" id="current-slide">
                            <span class="material-symbols-rounded video-placeholder-icon">movie</span>
                            <p>Click "Generate Video" to create a slideshow presentation</p>
                        </div>
                    </div>
                    <div class="video-controls">
                        <button class="video-control-btn" id="video-prev-btn">
                            <span class="material-symbols-rounded">skip_previous</span>
                        </button>
                        <button class="video-control-btn" id="video-play-btn">
                            <span class="material-symbols-rounded">play_arrow</span>
                        </button>
                        <button class="video-control-btn" id="video-next-btn">
                            <span class="material-symbols-rounded">skip_next</span>
                        </button>
                        <span class="slide-counter" id="slide-counter">0 / 0</span>
                    </div>
                </div>
                <div class="video-options">
                    <button class="btn-primary" id="generate-video-btn">
                        <span class="material-symbols-rounded">movie_edit</span>
                        Generate Video Slides
                    </button>
                    <button class="btn-secondary" id="export-video-btn" style="display: none;">
                        <span class="material-symbols-rounded">download</span>
                        Export as HTML
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mind Map Modal -->
    <div id="mindmap-modal" class="modal-overlay">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded" style="vertical-align: middle; margin-right: 8px;">hub</span>
                    Interactive Mind Map
                </h2>
                <button id="close-mindmap-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body mindmap-modal-body">
                <div class="mindmap-canvas" id="mindmap-canvas"></div>
                <div class="mindmap-actions">
                    <button class="btn-secondary" id="mindmap-zoom-in">
                        <span class="material-symbols-rounded">zoom_in</span>
                    </button>
                    <button class="btn-secondary" id="mindmap-zoom-out">
                        <span class="material-symbols-rounded">zoom_out</span>
                    </button>
                    <button class="btn-secondary" id="mindmap-reset">
                        <span class="material-symbols-rounded">center_focus_strong</span>
                    </button>
                    <button class="btn-primary" id="export-mindmap-btn">
                        <span class="material-symbols-rounded">download</span>
                        Export as PNG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reports-modal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">description</span>
                    Study Report
                </h2>
                <button id="close-reports-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body reports-modal-body">
                <div class="report-format-options">
                    <label>Report Format:</label>
                    <div class="format-buttons">
                        <button class="format-btn active" data-format="summary">Summary</button>
                        <button class="format-btn" data-format="detailed">Detailed</button>
                        <button class="format-btn" data-format="bullet">Bullet Points</button>
                        <button class="format-btn" data-format="study-guide">Study Guide</button>
                    </div>
                </div>
                <div class="report-content" id="report-content">
                    <div class="report-placeholder">
                        <span class="material-symbols-rounded">article</span>
                        <p>Select a format and the report will be generated from your infographic content.</p>
                    </div>
                </div>
                <div class="report-actions">
                    <button class="btn-primary" id="copy-report-btn">
                        <span class="material-symbols-rounded">content_copy</span>
                        Copy to Clipboard
                    </button>
                    <button class="btn-secondary" id="download-report-btn">
                        <span class="material-symbols-rounded">download</span>
                        Download as TXT
                    </button>
                    <button class="btn-secondary" id="print-report-btn">
                        <span class="material-symbols-rounded">print</span>
                        Print
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flashcards Modal -->
    <div id="flashcards-modal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">style</span>
                    Flashcards
                </h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="flashcard-counter" id="flashcard-counter">0 / 0</span>
                    <button id="close-flashcards-modal-btn" class="icon-btn-ghost">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body flashcards-modal-body">
                <div class="flashcard-container" id="flashcard-container">
                    <div class="flashcard" id="current-flashcard">
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <span class="flashcard-label">Question</span>
                                <p id="flashcard-question">Click "Generate Flashcards" to create study cards</p>
                            </div>
                            <div class="flashcard-back">
                                <span class="flashcard-label">Answer</span>
                                <p id="flashcard-answer">Answer will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flashcard-hint">Click the card to flip</div>
                <div class="flashcard-controls">
                    <button class="flashcard-nav-btn" id="prev-card-btn">
                        <span class="material-symbols-rounded">chevron_left</span>
                    </button>
                    <button class="flashcard-action-btn" id="shuffle-cards-btn">
                        <span class="material-symbols-rounded">shuffle</span>
                        Shuffle
                    </button>
                    <button class="flashcard-nav-btn" id="next-card-btn">
                        <span class="material-symbols-rounded">chevron_right</span>
                    </button>
                </div>
                <div class="flashcard-actions">
                    <button class="btn-primary" id="generate-flashcards-btn">
                        <span class="material-symbols-rounded">auto_fix_high</span>
                        Generate Flashcards
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="modal-overlay">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">quiz</span>
                    Knowledge Quiz
                </h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="quiz-score" id="quiz-score">Score: 0/0</span>
                    <button id="close-quiz-modal-btn" class="icon-btn-ghost">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body quiz-modal-body">
                <div class="quiz-container" id="quiz-container">
                    <div class="quiz-question-card">
                        <div class="quiz-progress">
                            <div class="quiz-progress-bar" id="quiz-progress-bar"></div>
                        </div>
                        <h3 class="quiz-question" id="quiz-question">Click "Start Quiz" to begin</h3>
                        <div class="quiz-options" id="quiz-options">
                            <!-- Options will be injected here -->
                        </div>
                    </div>
                    <div class="quiz-feedback" id="quiz-feedback" style="display: none;">
                        <span class="material-symbols-rounded" id="feedback-icon">check_circle</span>
                        <p id="feedback-text">Correct!</p>
                    </div>
                </div>
                <div class="quiz-results" id="quiz-results" style="display: none;">
                    <div class="results-circle">
                        <span class="results-percentage" id="results-percentage">0%</span>
                    </div>
                    <h3>Quiz Complete!</h3>
                    <p id="results-message">Great job!</p>
                    <button class="btn-primary" id="retake-quiz-btn">
                        <span class="material-symbols-rounded">refresh</span>
                        Retake Quiz
                    </button>
                </div>
                <div class="quiz-actions">
                    <button class="btn-primary" id="start-quiz-btn">
                        <span class="material-symbols-rounded">play_arrow</span>
                        Start Quiz
                    </button>
                    <button class="btn-secondary" id="next-question-btn" style="display: none;">
                        Next Question
                        <span class="material-symbols-rounded">arrow_forward</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Slide Deck Modal -->
    <div id="slidedeck-modal" class="modal-overlay">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">slideshow</span>
                    Slide Deck
                </h2>
                <button id="close-slidedeck-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body slidedeck-modal-body">
                <div class="slidedeck-preview" id="slidedeck-preview">
                    <div class="slide-frame" id="slide-frame">
                        <div class="slide-content" id="slide-content">
                            <span class="material-symbols-rounded slide-placeholder-icon">presentation</span>
                            <p>Generate slides from your infographic</p>
                        </div>
                    </div>
                </div>
                <div class="slide-thumbnails" id="slide-thumbnails">
                    <!-- Thumbnails will be injected here -->
                </div>
                <div class="slidedeck-controls">
                    <button class="slide-nav-btn" id="slide-prev-btn">
                        <span class="material-symbols-rounded">chevron_left</span>
                    </button>
                    <span class="slide-indicator" id="slide-indicator">Slide 0 of 0</span>
                    <button class="slide-nav-btn" id="slide-next-btn">
                        <span class="material-symbols-rounded">chevron_right</span>
                    </button>
                </div>
                <div class="slidedeck-actions">
                    <button class="btn-primary" id="generate-slides-btn">
                        <span class="material-symbols-rounded">auto_fix_high</span>
                        Generate Slides
                    </button>
                    <button class="btn-secondary" id="present-slides-btn" style="display: none;">
                        <span class="material-symbols-rounded">cast</span>
                        Present
                    </button>
                    <button class="btn-secondary" id="export-slides-btn" style="display: none;">
                        <span class="material-symbols-rounded">download</span>
                        Export HTML
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Hub Modal -->
    <div id="community-modal" class="modal-overlay">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">groups</span>
                    Community Hub
                    <span id="community-count-badge" class="count-badge" style="display: none;">0</span>
                </h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="refresh-community-btn" class="icon-btn-ghost" title="Refresh">
                        <span class="material-symbols-rounded">refresh</span>
                    </button>
                    <button id="close-community-modal-btn" class="icon-btn-ghost">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body community-modal-body">
                <!-- Tabs for Pending / Approved -->
                <div class="community-tabs">
                    <button class="community-tab active" data-tab="pending">
                        <span class="material-symbols-rounded">pending</span>
                        New Uploads
                        <span class="tab-count" id="pending-count">0</span>
                    </button>
                    <button class="community-tab" data-tab="approved">
                        <span class="material-symbols-rounded">verified</span>
                        Community Gallery
                        <span class="tab-count" id="approved-count">0</span>
                    </button>
                </div>

                <!-- Pending Submissions View -->
                <div class="community-content" id="pending-content">
                    <div class="community-info-banner">
                        <span class="material-symbols-rounded">info</span>
                        <p>Fresh uploads from community members. They are published instantly so you can preview, like,
                            and add them to your local library.</p>
                    </div>
                    <div class="community-bulk-actions">
                        <button id="add-all-pending-to-library-btn" class="btn-primary"
                            style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-symbols-rounded">library_add</span>
                            Add All to Library
                        </button>
                        <span id="add-all-pending-progress" class="bulk-progress" style="display: none;"></span>
                    </div>
                    <div id="pending-submissions-list" class="community-grid">
                        <!-- Submissions will be injected here -->
                    </div>
                    <div id="pending-empty" class="community-empty" style="display: none;">
                        <span class="material-symbols-rounded">inbox</span>
                        <p>No new uploads at the moment.</p>
                    </div>
                </div>

                <!-- Approved Gallery View -->
                <div class="community-content" id="approved-content" style="display: none;">
                    <div class="community-info-banner success">
                        <span class="material-symbols-rounded">verified</span>
                        <p>These infographics are published by the community and available for everyone to use.</p>
                    </div>
                    <div class="community-bulk-actions">
                        <button id="add-all-to-library-btn" class="btn-primary"
                            style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="material-symbols-rounded">library_add</span>
                            Add All to Library
                        </button>
                        <span id="add-all-progress" class="bulk-progress" style="display: none;"></span>
                    </div>
                    <div id="approved-submissions-list" class="community-grid">
                        <!-- Approved items will be injected here -->
                    </div>
                    <div id="approved-empty" class="community-empty" style="display: none;">
                        <span class="material-symbols-rounded">folder_off</span>
                        <p>No community infographics yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit to Community Modal -->
    <div id="submit-community-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">cloud_upload</span>
                    Publish to Community Hub
                </h2>
                <button id="close-submit-modal-btn" class="icon-btn-ghost">
                    <span class="material-symbols-rounded">close</span>
                </button>
            </div>
            <div class="modal-body submit-modal-body">
                <div class="submit-preview">
                    <h3 id="submit-preview-title">Infographic Title</h3>
                    <p id="submit-preview-summary">Summary will appear here...</p>
                </div>

                <div class="submit-form">
                    <div class="form-group">
                        <label for="submitter-name">Your Name (Required)</label>
                        <input type="text" id="submitter-name" placeholder="Enter your name or alias" maxlength="50">
                        <small class="form-hint">This will be displayed publicly with your submission.</small>
                    </div>

                    <div class="submit-info">
                        <h4>What happens next?</h4>
                        <ul>
                            <li><span class="material-symbols-rounded">upload</span> Your infographic will be published
                                to the Community Hub</li>
                            <li><span class="material-symbols-rounded">visibility</span> Other users can view, like, and
                                add it to their library</li>
                            <li><span class="material-symbols-rounded">public</span> It appears instantly for everyone
                                visiting this site</li>
                        </ul>
                    </div>

                    <div class="submit-notice">
                        <span class="material-symbols-rounded">info</span>
                        <p>By submitting, you agree that your infographic may be shared publicly. Your IP address will
                            be recorded for moderation purposes.</p>
                    </div>
                </div>

                <div class="submit-actions">
                    <button id="cancel-submit-btn" class="btn-secondary">Cancel</button>
                    <button id="confirm-submit-btn" class="btn-primary">
                        <span class="material-symbols-rounded">send</span>
                        Publish Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Preview Modal -->
    <div id="community-preview-modal" class="modal-overlay">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h2>
                    <span class="material-symbols-rounded"
                        style="vertical-align: middle; margin-right: 8px;">preview</span>
                    <span id="preview-title">Preview</span>
                </h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="preview-meta" id="preview-author">
                        <span class="material-symbols-rounded">person</span>
                        Author
                    </span>
                    <button id="close-preview-modal-btn" class="icon-btn-ghost">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
            </div>
            <div class="modal-body preview-modal-body">
                <div id="preview-infographic-container" class="preview-container">
                    <!-- Infographic preview will be rendered here -->
                </div>
                <div class="preview-actions">
                    <button id="preview-like-btn" class="btn-secondary">
                        <span class="material-symbols-rounded">thumb_up</span>
                        Like
                    </button>
                    <button id="preview-download-btn" class="btn-primary" title="Admin only">
                        <span class="material-symbols-rounded">admin_panel_settings</span>
                        Add to Library (Admin)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Background Music Player -->
    <div id="music-player" class="music-player">
        <button id="music-toggle" class="music-toggle" title="Toggle Music">
            <span class="material-symbols-rounded" id="music-icon">music_note</span>
        </button>
        <div id="music-panel" class="music-panel hidden">
            <div class="music-header">
                <span class="material-symbols-rounded">radio</span>
                <span>Background Music</span>
            </div>
            <div class="music-stations">
                <button class="station-btn" data-station="classical" title="Classical FM">
                    <span class="material-symbols-rounded">piano</span>
                    <span>Classical FM</span>
                </button>
                <button class="station-btn" data-station="quran" title="Quran Radio - Al Minshawi">
                    <span class="material-symbols-rounded">menu_book</span>
                    <span>Quran - Minshawi</span>
                </button>
            </div>
            <div class="music-controls">
                <button id="music-play-pause" class="music-btn" disabled>
                    <span class="material-symbols-rounded">play_arrow</span>
                </button>
                <input type="range" id="music-volume" min="0" max="100" value="30" class="volume-slider">
                <span class="material-symbols-rounded volume-icon">volume_up</span>
            </div>
            <div id="music-status" class="music-status">Select a station</div>
        </div>
        <audio id="music-audio" crossorigin="anonymous"></audio>
    </div>

    <!-- Script -->
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script src="firebase-storage.js"></script>
    <script src="community-submissions.js"></script>
    <!-- Load Google Generative AI as fallback for local file:// protocol -->
    <script>
        // Detect if running locally via file:// protocol
        if (window.location.protocol === 'file:') {
            console.warn('Running locally via file:// protocol. ES modules may not work. Please use a local server (e.g., npx serve) or access via GitHub Pages.');
        }
    </script>
    <script type="module" src="script.js"></script>
</body>

</html>